#!/usr/bin/env python3
"""
Simple Photo Editor CLI - Works with any AI assistant or CLI tool

Usage:
    photo button image.png          # Create a button
    photo banner image.png          # Create a banner
    photo postcard image.png        # Create a postcard
    photo upscale image.png         # AI upscale 4x
    photo upscale image.png 2       # AI upscale 2x
    photo rembg image.png           # Remove background
    photo vector image.png          # Convert to SVG
    photo resize image.png 800 600  # Resize to 800x600
    photo list                      # Show all presets

Any AI CLI (Claude, Codex, Cursor) can use these commands directly.
"""

import sys
import os
from pathlib import Path

# Add script directory to path for imports
script_dir = Path(__file__).parent.absolute()
sys.path.insert(0, str(script_dir))

from photo_editor import PhotoEditor, UpscaleModel, VectorMode
from format_converter import FormatConverter
from presets import ALL_PRESETS, list_presets


def main():
    if len(sys.argv) < 2:
        print_usage()
        return 1

    command = sys.argv[1].lower()

    # List presets
    if command in ['list', 'presets', 'help', '-h', '--help']:
        if command == 'help' or command.startswith('-'):
            print_usage()
        list_presets()
        return 0

    # Need at least command + image
    if len(sys.argv) < 3:
        print(f"Usage: photo {command} <image>")
        return 1

    image_path = sys.argv[2]

    if not os.path.exists(image_path):
        print(f"Error: File not found: {image_path}")
        return 1

    # Initialize tools
    editor = PhotoEditor()
    converter = FormatConverter(output_base="output")
    input_path = Path(image_path)

    # Handle different commands
    if command == 'upscale':
        scale = int(sys.argv[3]) if len(sys.argv) > 3 else 4
        if scale not in [2, 4]:
            scale = 4
        output_dir = Path("output/upscaled")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}_upscaled_{scale}x.png"
        model = UpscaleModel.GENERAL_X4 if scale == 4 else UpscaleModel.GENERAL_X2
        print(f"Upscaling {image_path} {scale}x...")
        result = editor.ai_upscale(input_path, output_path, scale=scale, model=model)

    elif command in ['rembg', 'nobg', 'removebg', 'transparent']:
        output_dir = Path("output/no_background")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}_nobg.png"
        print(f"Removing background from {image_path}...")
        result = editor.remove_background(input_path, output_path)

    elif command in ['vector', 'svg', 'vectorize']:
        output_dir = Path("output/vectors")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}.svg"
        print(f"Converting {image_path} to SVG...")
        result = editor.vectorize(input_path, output_path)

    elif command == 'resize':
        if len(sys.argv) < 5:
            print("Usage: photo resize <image> <width> <height>")
            return 1
        width = int(sys.argv[3])
        height = int(sys.argv[4])
        output_dir = Path("output/resized")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}_{width}x{height}.png"
        print(f"Resizing {image_path} to {width}x{height}...")
        result = editor.smart_resize(input_path, output_path, width=width, height=height)

    elif command in ALL_PRESETS:
        # Direct preset name
        print(f"Converting {image_path} to {command}...")
        result = converter.convert(image_path, command)

    else:
        # Check for common aliases
        aliases = {
            'button': 'button',
            'btn': 'button',
            'banner': 'banner',
            'twitter': 'twitter_banner',
            'instagram': 'instagram_square',
            'ig': 'instagram_square',
            'story': 'instagram_story',
            'facebook': 'facebook_post',
            'fb': 'facebook_post',
            'linkedin': 'linkedin_post',
            'youtube': 'youtube_thumbnail',
            'yt': 'youtube_thumbnail',
            'postcard': 'postcard',
            'flyer': 'flyer',
            'poster': 'poster',
            'icon': 'icon',
            'favicon': 'favicon',
            'thumb': 'thumbnail',
            'thumbnail': 'thumbnail',
            'hero': 'hero',
            'avatar': 'avatar',
            'card': 'business_card',
        }

        preset_name = aliases.get(command)
        if preset_name:
            print(f"Converting {image_path} to {preset_name}...")
            result = converter.convert(image_path, preset_name)
        else:
            print(f"Unknown command: {command}")
            print("\nAvailable commands:")
            print("  upscale, rembg, vector, resize")
            print("  button, banner, postcard, flyer, icon, thumbnail, hero...")
            print("\nRun 'photo list' to see all format presets")
            return 1

    # Report result
    if result.success:
        print(f"Done! Output: {result.output_path}")
        return 0
    else:
        print(f"Error: {result.message}")
        return 1


def print_usage():
    print("""
Photo Editor CLI - Simple commands for any AI assistant

USAGE:
    photo <command> <image> [options]

COMMANDS:
    photo button image.png          Create a button (200x60)
    photo banner image.png          Create a banner (1500x500)
    photo postcard image.png        Create a postcard (1800x1200)
    photo flyer image.png           Create a flyer (2550x3300)
    photo icon image.png            Create an icon (256x256)
    photo thumbnail image.png       Create a thumbnail (300x300)
    photo hero image.png            Create a hero image (1920x1080)

    photo upscale image.png         AI upscale 4x (Real-ESRGAN)
    photo upscale image.png 2       AI upscale 2x
    photo rembg image.png           Remove background (AI)
    photo vector image.png          Convert to SVG

    photo resize image.png 800 600  Resize to exact dimensions

    photo list                      Show all format presets
    photo help                      Show this help

ALIASES:
    btn → button    ig → instagram    yt → youtube
    fb → facebook   thumb → thumbnail

OUTPUT:
    All files saved to ./output/ organized by type

EXAMPLES:
    photo banner logo.png           # Create Twitter banner
    photo upscale ai_art.png        # Upscale small AI image
    photo rembg portrait.jpg        # Remove background
    photo postcard vacation.png     # Print-ready postcard
""")


if __name__ == "__main__":
    sys.exit(main() or 0)
