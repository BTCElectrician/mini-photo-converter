#!/usr/bin/env python3
"""
Simple Photo Editor CLI - Works with any AI assistant or CLI tool

Usage:
    photo button image.png          # Create a button
    photo banner image.png          # Create a banner
    photo postcard image.png        # Create a postcard
    photo upscale image.png         # AI upscale 4x
    photo upscale image.png 2       # AI upscale 2x
    photo rembg image.png           # Remove background
    photo vector image.png          # Convert to SVG
    photo resize image.png 800 600  # Resize to 800x600
    photo list                      # Show all presets

Any AI CLI (Claude, Codex, Cursor) can use these commands directly.
"""

import sys
import os
from pathlib import Path

# Add script directory to path for imports
script_dir = Path(__file__).parent.absolute()
sys.path.insert(0, str(script_dir))

from photo_editor import PhotoEditor, UpscaleModel, VectorMode
from format_converter import FormatConverter
from presets import ALL_PRESETS, list_presets, FitMode


def main():
    if len(sys.argv) < 2:
        print_usage()
        return 1

    # Check for --fit flag (keep whole image with letterbox)
    use_fit_mode = '--fit' in sys.argv or '-f' in sys.argv
    args = [a for a in sys.argv if a not in ['--fit', '-f']]

    command = args[1].lower() if len(args) > 1 else ''

    # List presets
    if command in ['list', 'presets', 'help', '-h', '--help']:
        if command == 'help' or command.startswith('-'):
            print_usage()
        list_presets()
        return 0

    # Need at least command + image
    if len(args) < 3:
        print(f"Usage: photo {command} <image>")
        return 1

    image_path = args[2]

    if not os.path.exists(image_path):
        print(f"Error: File not found: {image_path}")
        return 1

    # Initialize tools
    editor = PhotoEditor()
    converter = FormatConverter(output_base="output")
    input_path = Path(image_path)

    # Fit mode override for format conversions
    fit_override = FitMode.FIT if use_fit_mode else None

    # Handle different commands
    if command == 'upscale':
        scale = int(sys.argv[3]) if len(sys.argv) > 3 else 4
        if scale not in [2, 4]:
            scale = 4
        output_dir = Path("output/upscaled")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}_upscaled_{scale}x.png"
        model = UpscaleModel.GENERAL_X4 if scale == 4 else UpscaleModel.GENERAL_X2
        print(f"Upscaling {image_path} {scale}x...")
        result = editor.ai_upscale(input_path, output_path, scale=scale, model=model)

    elif command in ['rembg', 'nobg', 'removebg', 'transparent']:
        output_dir = Path("output/no_background")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}_nobg.png"
        print(f"Removing background from {image_path}...")
        result = editor.remove_background(input_path, output_path)

    elif command in ['vector', 'svg', 'vectorize']:
        output_dir = Path("output/vectors")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}.svg"
        print(f"Converting {image_path} to SVG...")
        result = editor.vectorize(input_path, output_path)

    elif command == 'resize':
        if len(sys.argv) < 5:
            print("Usage: photo resize <image> <width> <height>")
            return 1
        width = int(sys.argv[3])
        height = int(sys.argv[4])
        output_dir = Path("output/resized")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}_{width}x{height}.png"
        print(f"Resizing {image_path} to {width}x{height}...")
        result = editor.smart_resize(input_path, output_path, width=width, height=height)

    elif command in ['watermark', 'nowm', 'rmwm', 'dewatermark']:
        # Remove watermark (default: bottom-right for Gemini)
        position = sys.argv[3] if len(sys.argv) > 3 else "bottom-right"
        output_dir = Path("output/no_watermark")
        output_dir.mkdir(parents=True, exist_ok=True)
        output_path = output_dir / f"{input_path.stem}_nowm.png"
        print(f"Removing watermark from {image_path} ({position})...")
        result = editor.remove_watermark(input_path, output_path, watermark_position=position)

    elif command in ALL_PRESETS:
        # Direct preset name
        mode_text = " (fit mode - keeping whole image)" if use_fit_mode else ""
        print(f"Converting {image_path} to {command}{mode_text}...")
        result = converter.convert(image_path, command, fit_mode_override=fit_override)

    else:
        # Check for common aliases
        aliases = {
            'button': 'button',
            'btn': 'button',
            'banner': 'banner',
            'twitter': 'twitter_banner',
            'instagram': 'instagram_square',
            'ig': 'instagram_square',
            'story': 'instagram_story',
            'facebook': 'facebook_post',
            'fb': 'facebook_post',
            'linkedin': 'linkedin_post',
            'youtube': 'youtube_thumbnail',
            'yt': 'youtube_thumbnail',
            'postcard': 'postcard',
            'flyer': 'flyer',
            'poster': 'poster',
            'icon': 'icon',
            'favicon': 'favicon',
            'thumb': 'thumbnail',
            'thumbnail': 'thumbnail',
            'hero': 'hero',
            'avatar': 'avatar',
            'card': 'business_card',
        }

        preset_name = aliases.get(command)
        if preset_name:
            mode_text = " (fit mode - keeping whole image)" if use_fit_mode else ""
            print(f"Converting {image_path} to {preset_name}{mode_text}...")
            result = converter.convert(image_path, preset_name, fit_mode_override=fit_override)
        else:
            print(f"Unknown command: {command}")
            print("\nAvailable commands:")
            print("  upscale, rembg, vector, resize")
            print("  button, banner, postcard, flyer, icon, thumbnail, hero...")
            print("\nRun 'photo list' to see all format presets")
            return 1

    # Report result
    if result.success:
        print(f"Done! Output: {result.output_path}")
        return 0
    else:
        print(f"Error: {result.message}")
        return 1


def print_usage():
    print("""
Photo Editor CLI - Simple commands for any AI assistant

USAGE:
    photo <command> <image> [options]

COMMANDS:
    photo button image.png          Create a button (200x60)
    photo banner image.png          Create a banner (1500x500)
    photo postcard image.png        Create a postcard (1800x1200)
    photo flyer image.png           Create a flyer (2550x3300)
    photo icon image.png            Create an icon (256x256)
    photo thumbnail image.png       Create a thumbnail (300x300)
    photo hero image.png            Create a hero image (1920x1080)

    photo upscale image.png         AI upscale 4x (Real-ESRGAN)
    photo upscale image.png 2       AI upscale 2x
    photo rembg image.png           Remove background (AI)
    photo watermark image.png       Remove watermark (AI inpainting)
    photo vector image.png          Convert to SVG

    photo resize image.png 800 600  Resize to exact dimensions

    photo list                      Show all format presets
    photo help                      Show this help

OPTIONS:
    --fit, -f                       Keep whole image (add letterbox padding)
                                    Without --fit: crops to fill dimensions
                                    With --fit: fits inside, adds black bars

ALIASES:
    btn → button    ig → instagram    yt → youtube
    fb → facebook   thumb → thumbnail

OUTPUT:
    All files saved to ./output/ organized by type

EXAMPLES:
    photo banner logo.png           # Create banner (crops to fit)
    photo banner logo.png --fit     # Create banner (keeps whole image)
    photo upscale ai_art.png        # Upscale small AI image
    photo rembg portrait.jpg        # Remove background
    photo thumbnail art.png --fit   # Thumbnail with letterbox
""")


if __name__ == "__main__":
    sys.exit(main() or 0)
